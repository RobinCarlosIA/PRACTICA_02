# chat_klg_publicidad.py
# Escribe 'salir' para terminar.

import json
import os
import re

KB_FILE = "kb_klg_publicidad.json" 

# 3 lÃ­neas precargadas (marca: KLG PUBLICIDAD)
DEFAULT_KB = [
    {"q": "hola", "a": "Â¡Hola! Bienvenid@ a KLG PUBLICIDAD âœ¨"},
    {"q": "como estas?", "a": "Â¡Muy bien! Â¿Y tÃº? Â¿Buscas campaÃ±as, branding o anuncios?"},
    {"q": "de que te gustarÃ­a hablar?", "a": "Podemos hablar de redes sociales, pauta, branding o ideas creativas."}
]

def normalize(s: str) -> str:
    """Normaliza: minÃºsculas, quita acentos bÃ¡sicos, limpia espacios/sÃ­mbolos."""
    s = s.lower()
    s = (s.replace("Ã¡", "a").replace("Ã©", "e").replace("Ã­", "i")
           .replace("Ã³", "o").replace("Ãº", "u").replace("Ã¼", "u"))
    s = re.sub(r"[^a-z0-9Â¿?Â¡!Ã±\s]", " ", s)  # deja letras, nÃºmeros, espacios y signos ?!Â¿Â¡
    s = re.sub(r"\s+", " ", s).strip()
    return s

def load_kb():
    """Carga la KB si existe; si no, crea la inicial."""
    if not os.path.exists(KB_FILE):
        save_kb(DEFAULT_KB)
        return list(DEFAULT_KB)
    try:
        with open(KB_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
            if isinstance(data, list):
                return data
    except Exception:
        pass
    return list(DEFAULT_KB)

def save_kb(kb):
    """Guarda la KB en disco."""
    with open(KB_FILE, "w", encoding="utf-8") as f:
        json.dump(kb, f, ensure_ascii=False, indent=2)

def buscar_respuesta(user_text: str, kb: list[dict]) -> str | None:
    """Coincidencia EXACTA tras normalizar (simple y claro para la prÃ¡ctica)."""
    n = normalize(user_text)
    for r in kb:
        if normalize(r["q"]) == n:
            return r["a"]
    return None

def main():
    kb = load_kb()
    print("KLG PUBLICIDAD â€” Chat simple con aprendizaje (escribe 'salir' para terminar).")
    print("Frases precargadas: 'hola' | 'como estas?' | 'de que te gustarÃ­a hablar?'")

    while True:
        user = input("\nTÃº: ").strip()
        if not user:
            continue
        if user.lower() == "salir":
            print("KLG: Â¡Hasta luego! ğŸ‘‹")
            break

        ans = buscar_respuesta(user, kb)
        if ans:
            print(f"KLG: {ans}")
        else:
            # AdquisiciÃ³n de conocimiento â€œen voz de agenciaâ€
            print(f'KLG: AÃºn no tengo respuesta para: "{user}".')
            nueva = input("KLG: Â¿QuÃ© deberÃ­amos responder cuando nos pregunten eso? (deja vacÃ­o para omitir): ").strip()
            if nueva:
                kb.append({"q": normalize(user), "a": nueva})
                save_kb(kb)
                print("KLG: Â¡Perfecto! Lo guardÃ© para la prÃ³xima.")
            else:
                print("KLG: Sin problema, no aprenderÃ© esta vez.")

if __name__ == "__main__":
    main()
